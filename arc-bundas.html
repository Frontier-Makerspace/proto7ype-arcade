<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ARC BUNDAS</title>
<style>
html,body{
  margin:0;
  background:#000;
  overflow:hidden;
}
canvas{display:block}
</style>
</head>
<body>

<canvas id="c"></canvas>

<script>
const c = document.getElementById("c")
const ctx = c.getContext("2d")

function resize(){
  c.width = innerWidth
  c.height = innerHeight
}
window.addEventListener("resize", resize)
resize()

let paused=false
let score=0, laserFlash=0
let gameOver=false

const ship={x:0,y:0,a:0,sp:3}
const bullets=[], bundas=[], particles=[]

let lastFire=0,lastLaser=0
const fireDelay=180,laserDelay=1500

function clamp(o,r=0){
  o.x=Math.max(r, Math.min(c.width-r,o.x))
  o.y=Math.max(r, Math.min(c.height-r,o.y))
}

function spawnMeteor(){
  bundas.push({
    x:Math.random()*c.width,
    y:Math.random()*c.height,
    v:1+Math.random()*2,
    a:Math.random()*Math.PI*2,
    s:20+Math.random()*20
  })
}

function resetGame(){
  ship.x=c.width/2
  ship.y=c.height/2
  ship.a=0
  bullets.length=bundas.length=particles.length=0
  score=0
  for(let i=0;i<6;i++) spawnMeteor()
}

function fire(){
  const t=performance.now()
  if(t-lastFire<fireDelay) return
  lastFire=t
  bullets.push({
    x:ship.x+Math.cos(ship.a)*16,
    y:ship.y+Math.sin(ship.a)*16,
    a:ship.a,v:8
  })
}

function explode(x,y){
  for(let i=0;i<30;i++){
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*6,
      vy:(Math.random()-0.5)*6,
      life:40
    })
  }
}

function shipExplosion(x,y){
  // Dramatic explosion with more particles
  for(let i=0;i<100;i++){
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*12,
      vy:(Math.random()-0.5)*12,
      life:60
    })
  }
}

function fireLaser(){
  const t=performance.now()
  if(t-lastLaser<laserDelay) return
  lastLaser=t
  laserFlash=6

  for(let i=bundas.length-1;i>=0;i--){
    const dx=bundas[i].x-ship.x
    const dy=bundas[i].y-ship.y
    const ang=Math.atan2(dy,dx)
    const diff=Math.abs(Math.atan2(Math.sin(ang-ship.a),Math.cos(ang-ship.a)))
    if(diff<0.12){
      explode(bundas[i].x,bundas[i].y)
      bundas.splice(i,1)
      score+=300
    }
  }
}

function update(){
  if(paused || gameOver) return

  if(Math.random()<0.015) spawnMeteor()
  
  // Check ship collision with asteroids
  for(let i=0;i<bundas.length;i++){
    const dx=bundas[i].x-ship.x
    const dy=bundas[i].y-ship.y
    const dist=Math.sqrt(dx*dx+dy*dy)
    if(dist<bundas[i].s/2+15){
      // Ship hit asteroid!
      shipExplosion(ship.x,ship.y)
      gameOver=true
      return
    }
  }

  bullets.forEach((b,i)=>{
    b.x+=Math.cos(b.a)*b.v
    b.y+=Math.sin(b.a)*b.v
    if(b.x<0||b.x>c.width||b.y<0||b.y>c.height)
      bullets.splice(i,1)
  })

  bundas.forEach(o=>{
    o.x+=Math.cos(o.a)*o.v
    o.y+=Math.sin(o.a)*o.v
    clamp(o,o.s/2)
  })

  particles.forEach(p=>{
    p.x+=p.vx
    p.y+=p.vy
    p.life--
  })
  for(let i=particles.length-1;i>=0;i--){
    if(particles[i].life<=0) particles.splice(i,1)
  }

  for(let i=bundas.length-1;i>=0;i--){
    for(let j=bullets.length-1;j>=0;j--){
      const dx=bundas[i].x-bullets[j].x
      const dy=bundas[i].y-bullets[j].y
      if(dx*dx+dy*dy<bundas[i].s*bundas[i].s){
        explode(bundas[i].x,bundas[i].y)
        bundas.splice(i,1)
        bullets.splice(j,1)
        score+=100
        break
      }
    }
  }

  clamp(ship,20)
}

function drawShip(){
  ctx.save()
  ctx.translate(ship.x,ship.y)
  ctx.rotate(ship.a)
  ctx.beginPath()
  ctx.moveTo(20,0)
  ctx.lineTo(-14,-10)
  ctx.lineTo(-8,0)
  ctx.lineTo(-14,10)
  ctx.closePath()
  ctx.strokeStyle="#0f0"
  ctx.lineWidth=2
  ctx.stroke()
  ctx.restore()
}

function drawInstructions(){
  const lines = [
    "Joystick L/R: Rotate",
    "Joystick/Top: Forward",
    "Joystick/Down: Back",
    "Left/Right: Strafe",
    "SE: Big LASER",
    "ST: Small Gun"
  ]
  ctx.font="13px monospace"
  ctx.fillStyle="#0f0"
  lines.forEach((t,i)=>{
    ctx.fillText(t,20,25+i*17)
  })
}

function draw(){
  ctx.fillStyle=`rgba(0,0,0,${laserFlash?0.12:0.35})`
  ctx.fillRect(0,0,c.width,c.height)

  if(laserFlash){
    ctx.strokeStyle="#0ff"
    ctx.lineWidth=10
    ctx.beginPath()
    ctx.moveTo(ship.x,ship.y)
    ctx.lineTo(
      ship.x+Math.cos(ship.a)*2000,
      ship.y+Math.sin(ship.a)*2000
    )
    ctx.stroke()
    laserFlash--
  }

  if(!gameOver) drawShip()

  ctx.fillStyle="#aff"
  bullets.forEach(b=>ctx.fillRect(b.x,b.y,3,3))

  ctx.strokeStyle="#888"
  ctx.lineWidth=2
  bundas.forEach(o=>{
    ctx.strokeRect(o.x-o.s/2,o.y-o.s/2,o.s,o.s)
  })

  ctx.fillStyle="#ff0"
  particles.forEach(p=>{
    ctx.globalAlpha=p.life/40
    ctx.fillRect(p.x,p.y,2,2)
    ctx.globalAlpha=1
  })

  ctx.fillStyle="#0f0"
  ctx.font="20px monospace"
  ctx.fillText("SCORE "+score,20,25)

  // scanlines
  ctx.fillStyle="rgba(0,0,0,0.12)"
  for(let y=0;y<c.height;y+=4)
    ctx.fillRect(0,y,c.width,1)

  if(!gameOver) drawInstructions()
  
  // Game over screen
  if(gameOver){
    ctx.fillStyle="rgba(0,0,0,0.7)"
    ctx.fillRect(0,0,c.width,c.height)
    
    ctx.fillStyle="#f00"
    ctx.font="80px monospace"
    ctx.textAlign="center"
    ctx.fillText("GAME OVER",c.width/2,c.height/2-50)
    
    ctx.fillStyle="#0f0"
    ctx.font="40px monospace"
    ctx.fillText("FINAL SCORE: "+score,c.width/2,c.height/2+30)
    
    ctx.fillStyle="#ff0"
    ctx.font="25px monospace"
    ctx.fillText("PRESS START TO RESTART",c.width/2,c.height/2+100)
    
    ctx.fillStyle="#0ff"
    ctx.font="20px monospace"
    ctx.fillText("PRESS COIN TO RETURN TO MENU",c.width/2,c.height/2+140)
    
    ctx.textAlign="left"
  }
}

let pausePressed = false
let lastPauseTime = 0
let k3Pressed = false

function gamepad(){
  const gp = navigator.getGamepads()[0]
  if(!gp) return

  // K3 (Start) button (BTN 2) - Restart game when game over
  const k3Button = gp.buttons[2]?.pressed
  if(k3Button && !k3Pressed && gameOver){
    k3Pressed = true
    gameOver = false
    resetGame()
    return
  }
  if(!k3Button) k3Pressed = false
  
  // K2 (Coin) button (BTN 3) - Return to menu when game over
  if(gp.buttons[3]?.pressed && gameOver){
    window.location.href = 'index.html'
    return
  }
  
  if(gameOver) return  // Don't process other controls when game over

  const ax=gp.axes[0], ay=gp.axes[1]
  const dead=0.18
  
  // Joystick X-axis: Rotate ship
  if(Math.abs(ax)>dead) ship.a+=ax*0.05

  // Joystick Y-axis: Move forward/backward
  if(Math.abs(ay)>dead){
    ship.x += Math.cos(ship.a) * (-ay) * ship.sp
    ship.y += Math.sin(ship.a) * (-ay) * ship.sp
  }
  
  // Top button (BTN 7) - Move forward
  if(gp.buttons[7].pressed){
    ship.x += Math.cos(ship.a) * ship.sp
    ship.y += Math.sin(ship.a) * ship.sp
  }
  
  // Down button (BTN 4) - Move backward
  if(gp.buttons[4].pressed){
    ship.x -= Math.cos(ship.a) * ship.sp
    ship.y -= Math.sin(ship.a) * ship.sp
  }
  
  // Left button (BTN 5) - Strafe left
  if(gp.buttons[5].pressed){
    ship.x += Math.cos(ship.a - Math.PI/2) * ship.sp
    ship.y += Math.sin(ship.a - Math.PI/2) * ship.sp
  }
  
  // Right button (BTN 6) - Strafe right
  if(gp.buttons[6].pressed){
    ship.x += Math.cos(ship.a + Math.PI/2) * ship.sp
    ship.y += Math.sin(ship.a + Math.PI/2) * ship.sp
  }

  // SE button - Fire LASER (big gun)
  // Try buttons 8, 9, 10, 11, 12 for SE
  if(gp.buttons[8]?.pressed) {
    fireLaser()
  }
  
  // ST button - Fire bullets (small gun)  
  // Try next button for ST
  if(gp.buttons[9]?.pressed) {
    fire()
  }
  
  // Fallback: Also try buttons 10/11 in case SE/ST are there
  if(gp.buttons[10]?.pressed) {
    fireLaser()
  }
  if(gp.buttons[11]?.pressed) {
    fire()
  }
}

function loop(){
  gamepad()
  update()
  draw()
  requestAnimationFrame(loop)
}

resetGame()
loop()
</script>
</body>
</html>